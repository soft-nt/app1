---
phase: 08-city-configuration
plan: 05
type: execute
wave: 3
depends_on: ["08-01", "08-02", "08-03", "08-04"]
files_modified:
  - src/components/Header.tsx
  - src/App.tsx
  - src/App.css
autonomous: false

must_haves:
  truths:
    - "Gear icon visible in header"
    - "Clicking gear opens settings modal"
    - "City selection persists across page reloads"
    - "Weather widget updates when city changes"
    - "Default city is Geneva when no saved selection"
  artifacts:
    - path: "src/components/Header.tsx"
      provides: "Header with settings button"
      contains: "SettingsModal"
    - path: "src/App.tsx"
      provides: "City state management with persistence"
      contains: "selectedCity"
  key_links:
    - from: "src/App.tsx"
      to: "src/utils/storage.ts"
      via: "loadCity/saveCity"
      pattern: "(loadCity|saveCity)"
    - from: "src/App.tsx"
      to: "src/components/Header.tsx"
      via: "city prop"
      pattern: "city.*=.*selectedCity"
    - from: "src/components/Header.tsx"
      to: "src/components/WeatherWidget.tsx"
      via: "city prop"
      pattern: "WeatherWidget.*city="
---

<objective>
Wire all city configuration components together: add settings button to header, manage city state in App with localStorage persistence, pass city through component tree to WeatherWidget.

Purpose: Complete the city configuration feature by connecting all previously built components. This plan is the integration layer that makes all parts work together.
Output: Fully functional city configuration with persistence, user can select city and see weather update
</objective>

<execution_context>
@/home/ntorrent/.claude/get-shit-done/workflows/execute-plan.md
@/home/ntorrent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-city-configuration/08-RESEARCH.md

# All prior plan outputs (must exist)
@src/types/city.ts
@src/data/cities.ts
@src/utils/storage.ts
@src/components/SettingsModal.tsx
@src/components/CitySelector.tsx
@src/components/CityMap.tsx
@src/components/WeatherWidget.tsx
@src/components/Header.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settings button and modal to Header</name>
  <files>src/components/Header.tsx</files>
  <action>
Modify Header to include settings gear icon and integrate SettingsModal:

1. Add new props to Header:
```typescript
type HeaderProps = {
  color: string;
  city: City;
  onCityChange: (city: City) => void;
};
```

2. Add useState for modal open/close state:
```typescript
const [isSettingsOpen, setIsSettingsOpen] = useState(false);
```

3. Import required components:
```typescript
import SettingsModal from './SettingsModal';
import CitySelector from './CitySelector';
import CityMap from './CityMap';
import type { City } from '../types/city';
```

4. Add gear icon button after WeatherWidget:
```tsx
<button
  onClick={() => setIsSettingsOpen(true)}
  className="settings-btn"
  aria-label="Open settings"
>
  ⚙️
</button>
```

5. Add SettingsModal with CitySelector and CityMap as children:
```tsx
<SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)}>
  <h2 className="modal-header">Settings</h2>
  <h3>Select City</h3>
  <CitySelector selectedCity={city} onSelectCity={onCityChange} />
  <CityMap city={city} />
</SettingsModal>
```

6. Pass city prop to WeatherWidget:
```tsx
<WeatherWidget city={city} />
```
  </action>
  <verify>Gear icon visible in header, clicking opens modal with city selector and map</verify>
  <done>Header shows gear icon, modal opens with city selector and map display</done>
</task>

<task type="auto">
  <name>Task 2: Wire city state in App with persistence</name>
  <files>src/App.tsx, src/App.css</files>
  <action>
Update App.tsx to manage city state with localStorage persistence:

1. Add imports:
```typescript
import { useState, useEffect } from 'react';
import { CITIES, DEFAULT_CITY } from './data/cities';
import { loadCity, saveCity } from './utils/storage';
import type { City } from './types/city';
```

2. Initialize city state from localStorage:
```typescript
function App() {
  const [color, setColor] = useState('#000000');

  // Initialize city from localStorage or default
  const [selectedCity, setSelectedCity] = useState<City>(() => {
    const savedCityId = loadCity();
    if (savedCityId) {
      const found = CITIES.find(c => c.id === savedCityId);
      if (found) return found;
    }
    return DEFAULT_CITY;
  });

  // ... rest of App
}
```

3. Create city change handler that persists:
```typescript
const handleCityChange = (city: City) => {
  setSelectedCity(city);
  saveCity(city.id);
};
```

4. Pass city and handler to Header:
```tsx
<Header color={color} city={selectedCity} onCityChange={handleCityChange} />
```

5. Add CSS for settings button in App.css:
```css
.settings-btn {
  background: transparent;
  border: none;
  font-size: 1.25rem;
  cursor: pointer;
  padding: 0.25rem;
  opacity: 0.7;
  transition: opacity 0.15s;
}

.settings-btn:hover {
  opacity: 1;
}

.modal-header {
  margin: 0 0 1rem 0;
  font-size: 1.25rem;
}

.modal-header + h3 {
  margin: 0 0 0.5rem 0;
  font-size: 1rem;
  font-weight: 500;
  color: #666;
}
```
  </action>
  <verify>Select city, reload page, verify same city is selected and weather shows for it</verify>
  <done>City state managed in App, persists to localStorage, Header receives city props</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete city configuration feature: settings modal with gear icon, city selector with search/filter, city map, localStorage persistence, weather widget updates</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open browser to localhost:5173
3. Verify gear icon (⚙️) appears in header next to weather widget
4. Click gear icon - settings modal should open with backdrop overlay
5. Verify modal shows:
   - "Settings" header
   - "Select City" subheader
   - Search input with "Search cities..." placeholder
   - List of 20+ cities (scroll to verify)
   - Geneva highlighted with checkmark (default)
   - Map showing Geneva location
6. Type "par" in search - should filter to Paris (and any other matching cities)
7. Click "Paris, France" - should:
   - Show checkmark next to Paris
   - Map updates to show Paris
   - Modal stays open (user can see change)
8. Close modal (X button, backdrop click, or Esc key)
9. Weather widget should now show Paris weather
10. Reload page - Paris should still be selected, weather shows Paris
11. Verify rapid city switching doesn't cause wrong weather display
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Gear icon visible in header
2. Clicking gear opens settings modal
3. Modal contains city selector and map
4. City selector shows all cities with filter
5. Selected city has visual indicator
6. Map shows correct city location
7. Closing modal updates weather widget to selected city
8. City selection persists across page reload
9. Default city is Geneva when localStorage empty
10. All close methods work (X, backdrop, Esc)
</verification>

<success_criteria>
All 10 success criteria from roadmap verified:
1. User can click gear icon in header to open settings modal
2. Settings modal displays with backdrop overlay and can be closed via X button or backdrop click
3. Modal styling matches app's existing design language
4. User sees searchable list of 20+ cities in dropdown within settings
5. User can filter cities by typing and see filtered results update in real-time
6. User can select a city and selection persists across page reloads
7. Currently selected city shows visual indicator (checkmark/highlight) in list
8. Weather widget automatically updates to show data for newly selected city
9. Loading state appears during city change with proper error handling for failed fetches
10. Map visual in settings displays location of selected city with clean integration
</success_criteria>

<output>
After completion, create `.planning/phases/08-city-configuration/08-05-SUMMARY.md`
</output>
