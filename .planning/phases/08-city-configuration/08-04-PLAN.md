---
phase: 08-city-configuration
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/WeatherWidget.tsx
autonomous: true

must_haves:
  truths:
    - "Weather widget fetches data for provided city coordinates"
    - "Widget displays city name from props"
    - "Loading state appears during city switch"
    - "Error handling works for failed fetches"
  artifacts:
    - path: "src/components/WeatherWidget.tsx"
      provides: "Weather display with configurable city"
      exports: ["default"]
  key_links:
    - from: "src/components/WeatherWidget.tsx"
      to: "src/types/city.ts"
      via: "import type City"
      pattern: "import.*City.*from.*types/city"
    - from: "src/components/WeatherWidget.tsx"
      to: "Open-Meteo API"
      via: "fetch with city coordinates"
      pattern: "latitude=.*longitude="
---

<objective>
Modify WeatherWidget to accept city coordinates as props instead of using hardcoded Geneva coordinates.

Purpose: Enable weather display for any selected city. The existing three-state async pattern (loading/error/data) already handles state transitions; this plan adds props-based coordinates and refetch on city change.
Output: WeatherWidget that fetches weather for any city and re-fetches when city changes
</objective>

<execution_context>
@/home/ntorrent/.claude/get-shit-done/workflows/execute-plan.md
@/home/ntorrent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-city-configuration/08-RESEARCH.md

# Plan 01 output (must exist)
@src/types/city.ts

# File to modify
@src/components/WeatherWidget.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add city prop to WeatherWidget</name>
  <files>src/components/WeatherWidget.tsx</files>
  <action>
Modify WeatherWidget to accept city as a prop:

1. Import City type from '../types/city'

2. Add props interface:
```typescript
interface WeatherWidgetProps {
  city: City;
}
```

3. Change function signature to accept props:
```typescript
function WeatherWidget({ city }: WeatherWidgetProps)
```

4. Update useEffect dependency array to include city.id:
```typescript
useEffect(() => {
  // ... fetch logic
}, [city.id]); // Re-fetch when city changes
```

5. Use city.latitude and city.longitude in API URL instead of GENEVA_COORDS:
```typescript
const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.latitude}&longitude=${city.longitude}&current=temperature_2m,weather_code`;
```

6. Display city.name in the weather-location span instead of hardcoded "Geneva":
```tsx
<span className="weather-location">{city.name}</span>
```

7. Remove GENEVA_COORDS import (no longer needed)

IMPORTANT: Keep the existing ignore flag pattern for cleanup. The useEffect should set isLoading=true at the start of each fetch to show loading state during city switches.
  </action>
  <verify>Pass different city objects to WeatherWidget, verify it fetches correct data and displays city name</verify>
  <done>WeatherWidget accepts city prop, fetches weather for provided coordinates, displays city name</done>
</task>

<task type="auto">
  <name>Task 2: Handle city change loading state</name>
  <files>src/components/WeatherWidget.tsx</files>
  <action>
Ensure proper loading state when city changes:

1. At the start of useEffect (before fetch), reset loading state:
```typescript
useEffect(() => {
  let ignore = false;

  // Reset states for new fetch
  setIsLoading(true);
  setError(null);

  async function fetchWeather() {
    // ... existing fetch logic
  }

  fetchWeather();

  return () => { ignore = true; };
}, [city.id]);
```

2. PITFALL from RESEARCH.md - Race condition prevention:
The existing ignore flag pattern already handles this. When city changes:
- New effect runs, sets ignore=false for new request
- Old effect cleanup runs, sets ignore=true for old request
- If old request completes after new one started, ignore flag prevents state update

3. Verify the loading state shows "Loading..." when city changes (existing loading state UI should work).

4. Verify error state clears when starting new fetch (setError(null) at effect start).

No new UI changes needed - existing loading/error display should work for city changes.
  </action>
  <verify>Rapidly switch cities, verify no stale data displayed, loading state shows between fetches</verify>
  <done>Loading state appears during city switch, no race conditions, error state resets on new fetch</done>
</task>

</tasks>

<verification>
1. WeatherWidget accepts city prop (TypeScript compiles)
2. Weather data fetches for provided city coordinates
3. City name displays from props, not hardcoded
4. Loading state shows when city changes
5. Rapid city switching doesn't cause stale data display
6. Error state clears when starting new fetch
</verification>

<success_criteria>
- WeatherWidget is now configurable via city prop
- City changes trigger new fetch with loading state
- No race conditions when rapidly changing cities
- Backwards compatible - just needs city prop to be passed
</success_criteria>

<output>
After completion, create `.planning/phases/08-city-configuration/08-04-SUMMARY.md`
</output>
