---
phase: 07-api-integration-a-weather-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/components/WeatherWidget.tsx
  - src/App.css
autonomous: true

# NOTE: This plan uses Open-Meteo API per project decision v1.2 in STATE.md:
# "Switch to Open-Meteo API (no API key, CORS-enabled, production-ready)"
# Earlier roadmap references to OpenWeatherMap are outdated.

must_haves:
  truths:
    - "Weather data fetches from Open-Meteo API on page load"
    - "Current temperature displays in Celsius with degree symbol (e.g., 15째C)"
    - "Weather condition icon displays (sun, cloud, rain, etc.)"
    - "Weather condition text displays (e.g., Clear sky, Cloudy)"
    - "Loading state displays while fetching weather data"
    - "Error state displays if fetch fails with user-friendly message"
    - "Race conditions prevented with useEffect cleanup"
  artifacts:
    - path: "src/components/WeatherWidget.tsx"
      provides: "Complete weather widget with fetch, states, icon, and display"
      min_lines: 60
      contains: "useEffect"
    - path: "package.json"
      provides: "react-icons dependency"
      contains: "react-icons"
  key_links:
    - from: "src/components/WeatherWidget.tsx"
      to: "https://api.open-meteo.com"
      via: "fetch in useEffect"
      pattern: "fetch.*open-meteo"
    - from: "src/components/WeatherWidget.tsx"
      to: "src/types/weather.ts"
      via: "import WeatherData type"
      pattern: "import.*WeatherData.*from"
    - from: "src/components/WeatherWidget.tsx"
      to: "react-icons/wi"
      via: "import weather icons"
      pattern: "import.*from.*react-icons/wi"
---

<objective>
Implement complete weather widget with Open-Meteo API integration, loading/error states, temperature display, and weather condition icons.

Purpose: Complete the v1.2 Weather Widget milestone by fetching real weather data for Geneva and displaying it with proper state management.
Output: Fully functional WeatherWidget showing temperature, condition icon, and condition text with loading/error handling.
</objective>

<execution_context>
@/home/ntorrent/.claude/get-shit-done/workflows/execute-plan.md
@/home/ntorrent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-api-integration-a-weather-display/07-RESEARCH.md

# Existing code to modify
@src/components/WeatherWidget.tsx
@src/types/weather.ts
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-icons and create weather icon mapping</name>
  <files>package.json, src/components/WeatherWidget.tsx</files>
  <action>
1. Install react-icons: `npm install react-icons`

2. In WeatherWidget.tsx, add imports at the top:
   - Import weather icons from react-icons/wi: WiDaySunny, WiCloud, WiCloudy, WiRain, WiShowers, WiSnow, WiSnowflakeCold, WiThunderstorm, WiFog
   - Import WMO_WEATHER_CODES from '../types/weather'

3. Create a helper function `getWeatherIcon(code: number)` that maps WMO codes to react-icons:
   - 0 (Clear sky) -> WiDaySunny
   - 1-3 (Mainly clear, Partly cloudy, Overcast) -> WiCloud or WiCloudy
   - 45, 48 (Fog) -> WiFog
   - 51-55 (Drizzle) -> WiShowers
   - 61-67 (Rain) -> WiRain
   - 71-77 (Snow) -> WiSnow or WiSnowflakeCold
   - 80-82 (Rain showers) -> WiShowers
   - 85-86 (Snow showers) -> WiSnow
   - 95-99 (Thunderstorm) -> WiThunderstorm
   - Default fallback -> WiCloud

4. Function returns JSX element with size={24} prop for consistent sizing
  </action>
  <verify>
- `npm ls react-icons` shows installed version
- WeatherWidget.tsx compiles without TypeScript errors: `npx tsc --noEmit`
  </verify>
  <done>react-icons installed, getWeatherIcon function created and returns appropriate icon component for any WMO code</done>
</task>

<task type="auto">
  <name>Task 2: Implement weather fetch with loading/error states and display</name>
  <files>src/components/WeatherWidget.tsx, src/App.css</files>
  <action>
1. In WeatherWidget.tsx, add imports:
   - useState, useEffect from 'react'
   - WeatherData, GENEVA_COORDS, WMO_WEATHER_CODES from '../types/weather'

2. Add three state variables (three-state pattern from research):
   - `const [weatherData, setWeatherData] = useState<WeatherData | null>(null)`
   - `const [isLoading, setIsLoading] = useState(true)`
   - `const [error, setError] = useState<Error | null>(null)`

3. Implement useEffect with race condition prevention (ignore flag pattern from research):
   ```
   useEffect(() => {
     let ignore = false;

     async function fetchWeather() {
       try {
         const url = `https://api.open-meteo.com/v1/forecast?latitude=${GENEVA_COORDS.latitude}&longitude=${GENEVA_COORDS.longitude}&current=temperature_2m,weather_code`;
         const response = await fetch(url);

         if (!response.ok) {
           throw new Error(`HTTP error! status: ${response.status}`);
         }

         const data: WeatherData = await response.json();

         if (!ignore) {
           setWeatherData(data);
           setIsLoading(false);
         }
       } catch (err) {
         if (!ignore) {
           setError(err instanceof Error ? err : new Error('Failed to fetch weather'));
           setIsLoading(false);
         }
       }
     }

     fetchWeather();

     return () => { ignore = true; };
   }, []);
   ```

4. Implement conditional rendering (order matters):
   - If isLoading: return div with "Loading..." text and className="weather-loading"
   - If error: return div with "Weather unavailable" text and className="weather-error"
   - If !weatherData: return null (defensive)
   - Otherwise: render full weather display

5. Full weather display structure:
   ```jsx
   <div className="weather-widget">
     <span className="weather-location">Geneva</span>
     <span className="weather-icon">{getWeatherIcon(weatherData.current.weather_code)}</span>
     <span className="weather-temp">{Math.round(weatherData.current.temperature_2m)}째C</span>
     <span className="weather-condition">{WMO_WEATHER_CODES[weatherData.current.weather_code]}</span>
   </div>
   ```

6. In App.css, add styles for weather states:
   ```css
   .weather-loading,
   .weather-error {
     color: #666;
     font-size: 0.9rem;
   }

   .weather-icon {
     display: flex;
     align-items: center;
   }

   .weather-temp {
     font-weight: bold;
   }

   .weather-condition {
     color: #666;
     font-size: 0.9rem;
   }
   ```
  </action>
  <verify>
- `npm run dev` starts without errors
- Open browser to localhost, observe:
  1. Brief "Loading..." appears (may be very fast)
  2. Temperature shows with degree symbol (e.g., "15째C")
  3. Weather icon displays (sun, cloud, etc.)
  4. Condition text displays (e.g., "Clear sky")
- Test error state: temporarily change URL to invalid, verify "Weather unavailable" displays
- `npx tsc --noEmit` passes with no errors
  </verify>
  <done>WeatherWidget fetches from Open-Meteo API on mount, displays temperature with degree symbol, shows weather icon and condition text, handles loading/error states gracefully, and prevents race conditions with cleanup</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full integration:

1. **TypeScript compilation:** `npx tsc --noEmit` passes
2. **Build verification:** `npm run build` succeeds
3. **Runtime verification:** `npm run dev` and check:
   - Header shows date on left, weather on right
   - Weather shows: Geneva label, icon, temperature (e.g., "15째C"), condition text
   - Loading state appears briefly on page load
4. **Error handling:** Temporarily break the fetch URL, verify error message displays
5. **Network tab:** Verify single fetch to open-meteo.com on page load
</verification>

<success_criteria>
- [ ] react-icons installed and WMO-to-icon mapping function works
- [ ] Weather data fetches from Open-Meteo API on page load
- [ ] Temperature displays in Celsius with degree symbol
- [ ] Weather icon displays based on WMO code
- [ ] Weather condition text displays from WMO_WEATHER_CODES
- [ ] Loading state shows during fetch
- [ ] Error state shows on fetch failure
- [ ] Race conditions prevented with useEffect cleanup
- [ ] TypeScript compiles without errors
- [ ] Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-integration-a-weather-display/07-01-SUMMARY.md`
</output>
